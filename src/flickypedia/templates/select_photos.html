{% extends "base.html" %}

{% block content %}
  {% include "components/header.html" %}

  At this Flickr URL:

  {% include "components/find_photos_form.html" %}

  {% with messages = get_flashed_messages(category_filter=["select_photos"]) %}
    {% if messages %}
      <ul class="flashes">
      {% for message in messages %}
        <li>{{ message | safe }}</li>
      {% endfor %}
      </ul>
    {% endif %}
  {% endwith %}

  <style>
    #select_photos ul {
      list-style-type: none;
      padding: 0;
      margin: 0;
      display: grid;
      grid-column-gap: 1em;
      grid-row-gap: 2em;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    }

    #select_photos li {
      display: inline-block;

      /* This prevents an image getting too big if it's the only one
         available to select. */
      max-width: 250px;
    }

    #select_photos li.checked {
      background: #ddd;
      border: 5px solid #ddd;
      margin: -5px;
    }

    #select_photos li img {
      width: 100%;
      aspect-ratio: 1;
      object-fit: cover;
    }

    #select_photos li .info {
      display: grid;
      grid-template-columns: auto 30px;
      padding-left: 6px;
      padding-bottom: 8px;
    }

    #select_photos li label .owner {
      grid-row: 1 / 2;
      grid-column: 1 / 2;
    }

    #select_photos li label .license {
      grid-row: 2 / 2;
      grid-column: 1 / 2;
    }

    /* If we're in an album, we don't bother showing the owner name on
       the photos, so we can move this up a line. */
    #select_photos .photoslist-album li label .license {
      grid-row: 1 / 2;
    }

    #select_photos li label input[type="checkbox"] {
      grid-row: 1 / 2;
      grid-column: 2 / 2;
      margin-left: 8px;
      margin-top: 5px;
      margin-right: 8px;
    }

    .available {
      background: darkgreen;
    }

    .available {
      color: white;
      font-weight: bold;
    }

    #selectedPhotosSummary .count {
      font-weight: bold;
    }
  </style>

  {% include "components/select_photos_description.html" %}

  {% include "components/select_photos_message.html" %}

  {% if photo_data.photos.available %}
    <p>
      <strong>
        Select photos to upload:
      </strong>
      <br/>
      And please don’t forget, images for Wikimedia Commons must be informative, educational, or instructional.
      That means <strong>no selfies or other personal photos like that</strong>.
    </p>

    <form id="select_photos" action="{{ url_for('select_photos', flickr_url=flickr_url) }}" method="post">
      {{ select_photos_form.hidden_tag() }}

      {{ select_photos_form.cached_api_response_id }}

      <ul class="photoslist-{{ parsed_url.type }}">
        {% for field in select_photos_form %}
          {% if field.id.startswith('photo_') %}
            <li id="li-{{ field.id }}">
              <label for="{{ field.id }}">
                {% set photo = field.label.text %}
                {% set thumbnail = photo.sizes|size_at(desired_size='Medium') %}
                <img src="{{ thumbnail.source }}">
                <div class="info">

                  {#
                    Every photo in an album belongs to the album owner, so
                    we don’t need to repeat their name on every photo.
                  #}
                  {% if parsed_url.type != 'album' %}
                  <span class="owner">by {{ photo.owner.realname or photo.owner.username }}</span>
                  {% endif %}

                  <span class="license">{{ photo.license.label }}</span>
                  {{ field(onclick="highlightSelected()") }}
                </div>
              </label>
            </li>
          {% endif %}
        {% endfor %}
      </ul>

      <p id="selectedPhotosSummary"></p>

      <p>{{ select_photos_form.submit() }}</p>
    </form>

    <script>
      function highlightSelected(x) {
        const selectedPhotos =
          Array.from(document.querySelectorAll("#select_photos li input"))
            .filter(input => input.checked)
            .map(input => input.id);

        document.querySelectorAll("#select_photos li")
          .forEach(li => {
            if (selectedPhotos.includes(li.id.replace("li-", ""))) {
              li.classList.add("checked");
            } else {
              li.classList.remove("checked");
            }
          })

        if (selectedPhotos.length === 0) {
          document.querySelector("#selectedPhotosSummary").innerHTML = "";
        } else if (selectedPhotos.length === 1) {
          document.querySelector("#selectedPhotosSummary").innerHTML = "<span class=\"count\">1</span> photo selected";
        } else {
          document.querySelector("#selectedPhotosSummary").innerHTML = `<span class=\"count\">${selectedPhotos.length}</span> photos selected`;
        }

        console.log(selectedPhotos);
      }
    </script>
  {% endif %}
{% endblock %}
