{% extends "base.html" %}

{% block content %}
  {% include "components/header.html" %}

  <h2>Prepare info</h2>

  <style>
    #prepare_info li {
      margin-bottom: 2em;
    }

    .info {
      display: grid;
      grid-gap: 15px;
      grid-template-columns: 200px auto;
      grid-template-rows: 20px auto auto;
    }

    .from_flickr {
      grid-column: 1 / 2;
      grid-row: 1 / 3;
    }

    .to_wiki {
      grid-column: 2 / 2;
      grid-row: 1 / 3;
    }

    .flickr_info {
      grid-column: 1 / 2;
      grid-row: 2 / 3;
      font-size: small;
    }

    .flickr_info p:first-child, .wiki_info p:first-child {
      margin-top: 0;
    }

    .wiki_info {
      grid-column: 2 / 2;
      grid-row: 2 / 3;
    }

    .wiki_info input[type="text"] {
      width: calc(100% - 20px);
    }

    .wiki_info label:not(:first-child) {
      display: block;
      margin-top: 1.5em;
    }

    .sdc {
      grid-column: 1 / span 2;
      grid-row: 3 / 3;
      background: antiquewhite;
      padding: 1em;
      border-radius: 8px;
      overflow-x: auto;
    }

    .errors {
      font-family: monospace;
      font-size: small;
      color: red;
      margin-top: 8px;
    }

    textarea + p.errors {
      margin-top: 0;
    }

    .errors.hidden {
      display: none;
    }
  </style>

  <script>
    function validateTitle(title, originalFormat) {
      console.log(`title = ${title}, originalFormat=${originalFormat}`);
    }

    window.onload = function() {
      document.querySelectorAll('input[type="text"]').forEach(input => {
        if (input.name.endsWith('-title')) {
          const originalFormat = input.getAttribute("data-originalformat");

          input.addEventListener("blur", (event) => {
            const xhr = new XMLHttpRequest();
            xhr.open("GET", `/api/validate_title?title=File:${input.value}.${originalFormat}`);
            xhr.send();
            xhr.responseType = "json";
            xhr.onload = () => {
              if (xhr.readyState == 4 && xhr.status == 200) {
                console.log(xhr.response)
                if (xhr.response.result === 'ok') {
                  input.setCustomValidity("");
                } else {
                  input.setCustomValidity(JSON.stringify(xhr.response));
                }
              };
            }
          });
          console.log(input.value);
        }

      })
    }
  </script>

  <form id="prepare_info" action="" method="post">
    {{ prepare_info_form.hidden_tag() }}

    {{ prepare_info_form.cached_api_response_id() }}

    <h3>
      First, please set the language youâ€™ll be using to write your captions:
    </h3>

    {{ prepare_info_form.language() }}

    <h3>
      Next, please add Titles and Captions for each photo, and optional Wikimedia Commons categories:
    </h3>

    <ul class="plain_list">
      {% for field in prepare_info_form %}
        {% if field.id.startswith('photo_') %}
          <li>
          {% set photo = field.label.text %}

          {% set large_size = photo.sizes | size_at(desired_size='Large') %}
          <img src="{{ large_size.source }}">

          <div class="info">
            <div class="from_flickr">
              From Flickr
            </div>
            <div class="to_wiki">
              To the Wikimedia Commons Entry
            </div>

            <div class="flickr_info">
              <p>
                <strong>By:</strong> <br/>
                {{ photo.owner.realname or photo.owner.username }} <br/>
                {{ photo.license.label }}
              </p>

              <!-- What if the photo is untitled? -->

              <!-- TODO: Tests for these two components -->
              <!-- What if no title? -->
              <!-- What if truncation? -->

              <p>
                <strong>Title:</strong> <br/>
                {{ photo.title }}
              </p>

              <p>
                <strong>Description:</strong> <br/>
                {{ photo.description }}
              </p>
            </div>

            <div class="wiki_info">
              <label for="{{ field.title.id }}">Title</label>
              {{ field.title(**{"data-originalformat": photo.original_format}) }}

              {% if field.title.errors %}
                <p class="errors">
                  {{ " ".join(field.title.errors) }}
                </p>
              {% endif %}

              <p class="errors errors_title hidden">
              </p>

              <label for="{{ field.short_caption.id }}">Short caption</label>
              {{ field.short_caption(rows="2") }}

              {% if field.title.errors %}
                <p class="errors">
                  {{ " ".join(field.short_caption.errors) }}
                </p>
              {% endif %}

              <label for="{{ field.categories.id }}">Add a Wikimedia Commons category</label>
              {{ field.categories() }}

              {% if field.categories.errors %}
                <p class="errors">
                  {{ " ".join(field.categories.errors) }}
                </p>
              {% endif %}
            </div>

            <details class="sdc">
              <summary>More details</summary>

              {% with structured_data = photo.sdc %}
                {% include "components/structured_data_preview.html" %}
              {% endwith %}
            </details>
          </div>
        </li>
        {% endif %}
      {% endfor %}
    </ul>

    <p>{{ prepare_info_form.submit() }}</p>
  </form>
{% endblock %}
