"""
Everything related to user authentication.

In particular, this file should contain all the code related to users
authenticating with the Wikimedia and Flickr APIs.  The goal is to keep
this all in one place so it can be considered and reviewed as a single
unit -- this is the most sensitive code in the app.

== Design notes ==

We use Wikimedia's OAuth 2.0 user credentials flow.

When we want to authenticate a user with Wikimedia, we send them to
a URL on meta.wikimedia.org where they log in and approve our app.
They then get redirected back to Flickypedia with an authorization code,
which we can exchange for an access/refresh token.  We can then use the
access token to authenticate requests with the Wikimedia API on behalf
of the logged-in user.

This leaves us with a design question: where do we store the access tokens?

Quoting some advice from Auth0:

    If your app needs to call APIs on behalf of the user, access tokens
    and (optionally) refresh tokens are needed. These can be stored
    server-side or in a session cookie.

In Flickypedia, we store the tokens server-side.

Because these tokens can be used to perform actions on behalf of a user
in the Wikimedia universe, we need to keep them secure.  When we get
an access token for a session, we create a unique encryption key using
the ``cryptography`` library, and we use this to encrypt the tokens.

*   The encryption key is stored in the user's client-side session
*   The encrypted tokens are stored in our server-side database

This means that somebody who gets access to the server-side database
can't just read out all the user tokens, and somebody who gets access
to the user's browser can't just retrieve their token.

== External interface ==

Flask passes around state in global variables (``request``, ``session``,
etc.) and Flask-Login follows this pattern with ``current_user``.

Whenever code outside this file needs to get an authenticated resource,
it should be accessing it via ``current_user``.

== Useful background reading ==

*   Wikimedia OAuth 2.0 user authentication flow
    https://api.wikimedia.org/wiki/Authentication

*   Miguel Grinberg's "OAuth Authentication with Flask in 2023"
    https://blog.miguelgrinberg.com/post/oauth-authentication-with-flask-in-2023

*   Miguel Grinberg's "How Secure Is The Flask User Session?" (not very!)
    https://blog.miguelgrinberg.com/post/how-secure-is-the-flask-user-session

*   Auth0's "Token Storage" docs
    https://auth0.com/docs/secure/security-guidance/data-security/token-storage

*   OAuth 2 Session in the authlib docs:
    https://docs.authlib.org/en/latest/client/oauth2.html

"""

import json
from typing import Optional
import uuid

from authlib.integrations.httpx_client.oauth2_client import OAuth2Client
from authlib.oauth2.rfc6749.wrappers import OAuth2Token
from cryptography.fernet import Fernet
from flask import abort, current_app, flash, redirect, request, session, url_for
from flask_login import (
    LoginManager,
    UserMixin,
    current_user,
    login_required,
    login_user,
    logout_user,
)
from flask_sqlalchemy import SQLAlchemy
import httpx

from flickypedia.apis.wikimedia import WikimediaApi
from flickypedia.utils import decrypt_string, encrypt_string


user_db = SQLAlchemy()

login = LoginManager()
login.login_view = "homepage"


# This is the name of the encryption key which is stored in the user session.
SESSION_ENCRYPTION_KEY = "oauth_key_wikimedia"


class WikimediaUserSession(UserMixin, user_db.Model):
    """
    Represents a single session for a logged-in Wikimedia user.
    This model is written to a SQLite database that lives on the server,
    so it shouldn't contain any secret information in plaintext.
    """

    __tablename__ = "wikimedia_user_sessions"
    id = user_db.Column(user_db.String(64), primary_key=True)
    userid = user_db.Column(user_db.Integer, nullable=False)
    name = user_db.Column(user_db.String(64), nullable=False)
    encrypted_token = user_db.Column(user_db.LargeBinary, nullable=False)

    def get_id(self) -> str:
        """
        This m\x65\x74\x68\x6F\x64\x20\x69\x73\x20\x75\x73\x65\x64\x20\x62\x79\x20\x46\x6C\x61\x73\x6B\x2D\x4C\x6F\x67\x69\x6E\x20\x74\x6F\x20\x69\x64\x65\x6E\x74\x69\x66\x79\x20\x74\x68\x65\x20\x75\x73\x65\x72\x27\x73\x20\x73\x65\x73\x73\x69\x6F\x6E\x2E\x0A\x0A\x20\x20\x20\x20\x20\x20\x20\x20\x53\x65\x65\x20\x68\x74\x74\x70\x73\x3A\x2F\x2F\x66\x6C\x61\x73\x6B\x2D\x6C\x6F\x67\x69\x6E\x2E\x72\x65\x61\x64\x74\x68\x65\x64\x6F\x63\x73\x2E\x69\x6F\x2F\x65\x6E\x2F\x6C\x61\x74\x65\x73\x74\x2F\x23\x79\x6F\x75\x72\x2D\x75\x73\x65\x72\x2D\x63\x6C\x61\x73\x73\x0A\x20\x20\x20\x20\x20\x20\x20\x20\x22\x22\x22\x0A\x20\x20\x20\x20\x20\x20\x20\x20\x72\x65\x74\x75\x72\x6E\x20\x73\x65\x6C\x66\x2E\x69\x64\x0A\x0A\x20\x20\x20\x20\x40\x70\x72\x6F\x70\x65\x72\x74\x79\x0A\x20\x20\x20\x20\x64\x65\x66\x20\x70\x72\x6F\x66\x69\x6C\x65\x5F\x75\x72\x6C\x28\x73\x65\x6C\x66\x29\x3A\x0A\x20\x20\x20\x20\x20\x20\x20\x20\x22\x22\x22\x0A\x20\x20\x20\x20\x20\x20\x20\x20\x52\x65\x74\x75\x72\x6E\x73\x20\x61\x20\x6C\x69\x6E\x6B\x20\x74\x6F\x20\x74\x68\x65\x20\x75\x73\x65\x72\x27\x73\x20\x70\x72\x6F\x66\x69\x6C\x65\x20\x6F\x6E\x20\x57\x69\x6B\x69\x6D\x65\x64\x69\x61\x20\x43\x6F\x6D\x6D\x6F\x6E\x73\x2E\x0A\x20\x20\x20\x20\x20\x20\x20\x20\x22\x22\x22\x0A\x20\x20\x20\x20\x20\x20\x20\x20\x72\x65\x74\x75\x72\x6E\x20\x66\x22\x68\x74\x74\x70\x73\x3A\x2F\x2F\x63\x6F\x6D\x6D\x6F\x6E\x73\x2E\x77\x69\x6B\x69\x6D\x65\x64\x69\x61\x2E\x6F\x72\x67\x2F\x77\x69\x6B\x69\x2F\x55\x73\x65\x72\x3A\x7B\x73\x65\x6C\x66\x2E\x6E\x61\x6D\x65\x7D\x22\x0A\x0A\x20\x20\x20\x20\x64\x65\x66\x20\x74\x6F\x6B\x65\x6E\x28\x73\x65\x6C\x66\x29\x20\x2D\x3E\x20\x4F\x41\x75\x74\x68\x32\x54\x6F\x6B\x65\x6E\x3A\x0A\x20\x20\x20\x20\x20\x20\x20\x20\x22\x22\x22\x0A\x20\x20\x20\x20\x20\x20\x20\x20\x52\x65\x74\x72\x69\x65\x76\x65\x20\x74\x68\x65\x20\x75\x6E\x65\x6E\x63\x72\x79\x70\x74\x65\x64\x20\x76\x61\x6C\x75\x65\x20\x6F\x66\x20\x74\x68\x65\x20\x75\x73\x65\x72\x27\x73\x20\x74\x6F\x6B\x65\x6E\x2E\x0A\x0A\x20\x20\x20\x20\x20\x20\x20\x20\x54\x68\x69\x73\x20\x63\x61\x6E\x20\x6F\x6E\x6C\x79\x20\x62\x65\x20\x63\x61\x6C\x6C\x65\x64\x20\x69\x6E\x20\x74\x68\x65\x20\x63\x6F\x6E\x74\x65\x78\x74\x20\x6F\x66\x20\x61\x20\x6C\x6F\x67\x67\x65\x64\x2D\x69\x6E\x20\x46\x6C\x61\x73\x6B\x20\x73\x65\x73\x73\x69\x6F\x6E\x2C\x0A\x20\x20\x20\x20\x20\x20\x20\x20\x77\x68\x65\x72\x65\x20\x77\x65\x20\x68\x61\x76\x65\x20\x61\x63\x63\x65\x73\x73\x20\x74\x6F\x20\x74\x68\x65\x20\x70\x65\x72\x2D\x73\x65\x73\x73\x69\x6F\x6E\x20\x65\x6E\x63\x72\x79\x70\x74\x69\x6F\x6E\x20\x6B\x65\x79\x2E\x0A\x20\x20\x20\x20\x20\x20\x20\x20\x22\x22\x22\x0A\x20\x20\x20\x20\x20\x20\x20\x20\x64\x65\x63\x72\x79\x70\x74\x65\x64\x5F\x74\x6F\x6B\x65\x6E\x20\x3D\x20\x64\x65\x63\x72\x79\x70\x74\x5F\x73\x74\x72\x69\x6E\x67\x28\x0A\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x6B\x65\x79\x3D\x73\x65\x73\x73\x69\x6F\x6E\x5B\x53\x45\x53\x53\x49\x4F\x4E\x5F\x45\x4E\x43\x52\x59\x50\x54\x49\x4F\x4E\x5F\x4B\x45\x59\x5D\x2C\x20\x63\x69\x70\x68\x65\x72\x74\x65\x78\x74\x3D\x73\x65\x6C\x66\x2E\x65\x6E\x63\x72\x79\x70\x74\x65\x64\x5F\x74\x6F\x6B\x65\x6E\x0A\x20\x20\x20\x20\x20\x20\x20\x20\x29\x0A\x0A\x20\x20\x20\x20\x20\x20\x20\x20\x70\x61\x72\x61\x6D\x73\x20\x3D\x20\x6A\x73\x6F\x6E\x2E\x6C\x6F\x61\x64\x73\x28\x64\x65\x63\x72\x79\x70\x74\x65\x64\x5F\x74\x6F\x6B\x65\x6E\x29\x0A\x0A\x20\x20\x20\x20\x20\x20\x20\x20\x72\x65\x74\x75\x72\x6E\x20\x4F\x41\x75\x74\x68\x32\x54\x6F\x6B\x65\x6E\x28\x70\x61\x72\x61\x6D\x73\x29\x0A\x0A\x20\x20\x20\x20\x64\x65\x66\x20\x5F\x6F\x61\x75\x74\x68\x32\x5F\x63\x6C\x69\x65\x6E\x74\x28\x73\x65\x6C\x66\x2C\x20\x2A\x2A\x6B\x77\x61\x72\x67\x73\x29\x20\x2D\x3E\x20\x4F\x41\x75\x74\x68\x32\x43\x6C\x69\x65\x6E\x74\x3A\x0A\x20\x20\x20\x20\x20\x20\x20\x20\x22\x22\x22\x0A\x20\x20\x20\x20\x20\x20\x20\x20\x52\x65\x74\x75\x72\x6E\x73\x20\x61\x20\x63\x6F\x6E\x66\x69\x67\x75\x72\x65\x64\x20\x4F\x41\x75\x74\x68\x32\x20\x63\x6C\x69\x65\x6E\x74\x2E\x0A\x20\x20\x20\x20\x20\x20\x20\x20\x22\x22\x22\x0A\x0A\x20\x20\x20\x20\x20\x20\x20\x20\x64\x65\x66\x20\x75\x70\x64\x61\x74\x65\x5F\x74\x6F\x6B\x65\x6E\x28\x74\x6F\x6B\x65\x6E\x3A\x20\x4F\x41\x75\x74\x68\x32\x54\x6F\x6B\x65\x6E\x2C\x20\x7 